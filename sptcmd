#!/bin/sh
# simple pt trace a command
# sptcmd [-c comm-to-filer] cmd

if [ "$1" = "-c" ] ; then
	shift
	COMM=$1
	shift
else
	COMM=$(basename $1)
fi

if [ -r simple-pt.ko ] ; then
	/sbin/insmod simple-pt.ko start=0
else
	/sbin/modprobe simple-pt start=0
fi
C=/sys/module/simple_pt/parameters
echo $COMM > $C/comm_filter
echo 1 > $C/cr3_filter
echo 0 > $C/kernel
echo 1 > $C/user
T=/sys/kernel/debug/tracing
echo 1 > $T/events/pttp/exec_cr3/enable
echo > $T/trace
./sptdump "$@"
echo 0 > $T/events/pttp/exec_cr3/enable
grep -v '^#' $T/trace > sideband
